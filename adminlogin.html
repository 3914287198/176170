<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç•™è¨€ç®¡ç†åå°</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }

        /* ç™»å½•é¡µ */
        .login-container { display: flex; justify-content: center; align-items: center; min-height: 100vh; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); pointer-events: auto; }
        .login-box { background: white; padding: 40px; border-radius: 10px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); width: 100%; max-width: 400px; pointer-events: auto; }
        .login-box h2 { text-align: center; margin-bottom: 30px; color: #333; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; color: #666; font-weight: 500; }
        .form-group input { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px; transition: border-color 0.3s; }
        .form-group input:focus { outline: none; border-color: #667eea; }
        .btn-login { width: 100%; padding: 12px; background: #667eea; color: white; border: none; border-radius: 5px; font-size: 16px; cursor: pointer; transition: background 0.3s; }
        .btn-login:hover { background: #5568d3; }
        .error { color: #e74c3c; text-align: center; margin-top: 15px; font-size: 14px; }

        /* ç®¡ç†é¡µé¢ */
        .admin-page { display: none; }
        .header { background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .header h1 { font-size: 24px; color: #333; display: flex; justify-content: space-between; align-items: center; }
        .btn-logout { padding: 8px 20px; background: #e74c3c; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 14px; }
        .btn-logout:hover { background: #c0392b; }

        /* ç»Ÿè®¡å¡ç‰‡ */
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .stat-card { background: white; padding: 10px; border-radius: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); text-align: center; }
        .stat-card h3 { font-size: 20px; margin: 10px 0; }
        .stat-card.total { border-top: 4px solid #3498db; }
        .stat-card.total h3 { color: #3498db; }
        .stat-card.pending { border-top: 4px solid #f39c12; }
        .stat-card.pending h3 { color: #f39c12; }
        .stat-card.approved { border-top: 4px solid #2ecc71; }
        .stat-card.approved h3 { color: #2ecc71; }

        /* ç•™è¨€åˆ—è¡¨ */
        .comments { background: white; border-radius: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); overflow: hidden; }
        .tabs { display: flex; border-bottom: 1px solid #eee; }
        .tab { padding: 15px 25px; cursor: pointer; font-weight: 500; color: #666; border-bottom: 3px solid transparent; }
        .tab:hover { background: #f8f8f8; }
        .tab.active { color: #667eea; border-bottom-color: #667eea; }
        .comments-list { padding: 0; }
        .comment-item { padding: 20px; border-bottom: 1px solid #eee; transition: background 0.3s; }
        .comment-item:last-child { border-bottom: none; }
        .comment-item:hover { background: #fafafa; }
        .comment-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; }
        .comment-info { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
        .comment-name { font-weight: bold; color: #333; font-size: 16px; }
        .comment-time { color: #999; font-size: 13px; }
        .comment-ip { background: #e9ecef; padding: 3px 8px; border-radius: 3px; font-size: 12px; color: #666; }
        .comment-location { background: #d1ecf1; padding: 3px 8px; border-radius: 3px; font-size: 12px; color: #0c5460; }
        .badge { padding: 4px 10px; border-radius: 3px; font-size: 12px; font-weight: 500; }
        .badge.pending { background: #fff3cd; color: #856404; }
        .badge.approved { background: #d4edda; color: #155724; }
        .comment-content { margin: 15px 0; line-height: 1.6; color: #333; }
        .comment-reply { background: #f0f7ff; padding: 15px; border-radius: 5px; margin-top: 10px; border-left: 3px solid #667eea; }
        .comment-reply strong { color: #667eea; }
        .comment-reply-time { color: #999; font-size: 12px; margin-top: 5px; }
        .comment-actions { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 15px; pointer-events: auto; }
        .btn { padding: 6px 15px; border: none; border-radius: 4px; cursor: pointer; font-size: 13px; transition: all 0.3s; pointer-events: auto; }
        .btn:hover { transform: translateY(-1px); }
        .btn-primary { background: #667eea; color: white; }
        .btn-primary:hover { background: #5568d3; }
        .btn-success { background: #2ecc71; color: white; }
        .btn-success:hover { background: #27ae60; }
        .btn-danger { background: #e74c3c; color: white; }
        .btn-danger:hover { background: #c0392b; }
        .btn-outline { background: white; border: 1px solid #ddd; color: #666; }
        .btn-outline:hover { background: #f5f5f5; }

        /* æ¨¡æ€æ¡† */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; pointer-events: auto; }
        .modal-overlay.show { display: flex; pointer-events: auto; }
        .modal { background: white; width: 100%; max-width: 500px; border-radius: 10px; box-shadow: 0 10px 40px rgba(0,0,0,0.3); max-height: 90vh; overflow-y: auto; }
        .modal-header { padding: 20px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .modal-header h3 { margin: 0; color: #333; }
        .modal-close { background: none; border: none; font-size: 24px; cursor: pointer; color: #999; }
        .modal-close:hover { color: #333; }
        .modal-body { padding: 20px; }
        .modal-footer { padding: 20px; border-top: 1px solid #eee; display: flex; justify-content: flex-end; gap: 10px; }
        .modal textarea { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px; resize: vertical; min-height: 100px; }
        .modal textarea:focus { outline: none; border-color: #667eea; }
        .modal label { display: block; margin-bottom: 8px; color: #666; font-weight: 500; }
        .modal .original-content { background: #f8f8f8; padding: 15px; border-radius: 5px; margin-bottom: 15px; color: #666; }
        .modal .checkbox-group { margin: 15px 0; }
        .modal .checkbox-group input { margin-right: 8px; }

        /* åˆ†é¡µ */
        .pagination { display: flex; justify-content: center; align-items: center; gap: 10px; padding: 20px; }
        .pagination button { padding: 8px 16px; border: 1px solid #ddd; background: white; cursor: pointer; border-radius: 4px; transition: all 0.3s; }
        .pagination button:hover { background: #667eea; color: white; border-color: #667eea; }
        .pagination button.active { background: #667eea; color: white; border-color: #667eea; }
        .pagination button:disabled { opacity: 0.5; cursor: not-allowed; }
        .pagination-info { color: #666; font-size: 14px; }

        /* åŠ è½½å’Œç©ºçŠ¶æ€ */
        .loading { text-align: center; padding: 40px; color: #999; }
        .empty { text-align: center; padding: 40px; color: #999; }
        .hidden { display: none; }
    </style>
</head>
<body>
    <!-- ç™»å½•é¡µé¢ -->
    <div id="loginPage" class="login-container">
        <div class="login-box">
            <h2>ğŸ” ç®¡ç†åå°</h2>
            <div class="form-group">
                <label>ç”¨æˆ·å</label>
                <input type="text" id="loginUsername" placeholder="è¯·è¾“å…¥ç”¨æˆ·å" />
            </div>
            <div class="form-group">
                <label>å¯†ç </label>
                <input type="password" id="loginPassword" placeholder="è¯·è¾“å…¥å¯†ç " />
            </div>
            <button class="btn-login" onclick="doLogin()">ç™»å½•</button>
            <div id="loginError" class="error"></div>
        </div>
    </div>

    <!-- ç®¡ç†é¡µé¢ -->
    <div id="adminPage" class="admin-page">
        <div class="container">
            <div class="header">
                <h1>
                    ğŸ“ ç•™è¨€ç®¡ç†
                    <button class="btn-logout" onclick="doLogout()">é€€å‡ºç™»å½•</button>
                </h1>
            </div>

            <div class="stats">
                <div class="stat-card total">
                    <h3 id="statTotal">0</h3>
                    <p>æ€»ç•™è¨€æ•°</p>
                </div>
                <div class="stat-card pending">
                    <h3 id="statPending">0</h3>
                    <p>å¾…å®¡æ ¸</p>
                </div>
                <div class="stat-card approved">
                    <h3 id="statApproved">0</h3>
                    <p>å·²å®¡æ ¸</p>
                </div>
            </div>


            <div class="comments">
                <div class="tabs">
                    <div class="tab active" data-tab="all" onclick="switchTab('all')">å…¨éƒ¨</div>
                    <div class="tab" data-tab="pending" onclick="switchTab('pending')">å¾…å®¡æ ¸</div>
                    <div class="tab" data-tab="approved" onclick="switchTab('approved')">å·²å®¡æ ¸</div>
                </div>
                <div id="commentsList" class="comments-list">
                    <div class="loading">åŠ è½½ä¸­...</div>
                </div>
                <div id="paginationContainer"></div>
            </div>


            <div class="header" style="margin-bottom: 20px;">
                <h2>
                    ğŸ“¦ æ•°æ®ç®¡ç†
                    <div style="font-size: 14px; font-weight: normal;">
                        <button class="btn btn-primary" onclick="backupComments()" style="padding: 6px 15px;">å¤‡ä»½ç•™è¨€</button>
                        <button class="btn btn-outline" onclick="document.getElementById('restoreFile').click()" style="padding: 6px 15px;">è¿˜åŸç•™è¨€</button>
                        <input type="file" id="restoreFile" accept=".json" style="display: none;" onchange="restoreComments(event)">
                    </div>
                </h2>
            </div>


        </div>
    </div>

    <!-- ç¼–è¾‘æ¨¡æ€æ¡† -->
    <div id="editModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h3>ç¼–è¾‘ç•™è¨€</h3>
                <button class="modal-close" onclick="closeModal('editModal')">&times;</button>
            </div>
            <div class="modal-body">
                <label>åŸå†…å®¹ï¼š</label>
                <div id="editOriginal" class="original-content"></div>
                <label>æ–°å†…å®¹ï¼š</label>
                <textarea id="editContent"></textarea>
                <div class="checkbox-group">
                    <input type="checkbox" id="editApproved" />
                    <label for="editApproved">å®¡æ ¸é€šè¿‡</label>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('editModal')">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="submitEdit()">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <!-- å›å¤æ¨¡æ€æ¡† -->
    <div id="replyModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h3>å›å¤ç•™è¨€</h3>
                <button class="modal-close" onclick="closeModal('replyModal')">&times;</button>
            </div>
            <div class="modal-body">
                <label>ç•™è¨€å†…å®¹ï¼š</label>
                <div id="replyOriginal" class="original-content"></div>
                <label>å›å¤å†…å®¹ï¼š</label>
                <textarea id="replyContent" placeholder="è¯·è¾“å…¥å›å¤å†…å®¹..."></textarea>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('replyModal')">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="submitReply()">æäº¤</button>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://127.0.0.1:8787/api';
        const PROD_API = 'https://176170.176170.xyz/api';
        const USE_PROD = true;
        const API = USE_PROD ? PROD_API : API_BASE;

        let token = localStorage.getItem('adminToken');
        let currentTab = 'all';
        let currentEditId = null;
        let currentReplyId = null;
        let allComments = [];
        let currentPage = 1;
        let totalPages = 1;
        let totalComments = 0;

        // åˆå§‹åŒ–
        function init() {
            if (token) {
                showAdmin();
                loadStats();
                loadComments();
            } else {
                showLogin();
            }
        }

        // æ˜¾ç¤ºç™»å½•é¡µ
        function showLogin() {
            document.getElementById('loginPage').style.display = 'block';
            document.getElementById('adminPage').style.display = 'none';
        }

        // æ˜¾ç¤ºç®¡ç†é¡µ
        function showAdmin() {
            document.getElementById('loginPage').style.display = 'none';
            document.getElementById('adminPage').style.display = 'block';
        }

        // ç™»å½•
        async function doLogin() {
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value.trim();
            const errorDiv = document.getElementById('loginError');

            if (!username || !password) {
                errorDiv.textContent = 'è¯·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ';
                return;
            }

            errorDiv.textContent = 'ç™»å½•ä¸­...';

            try {
                const res = await fetch(`${API}/admin/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                const data = await res.json();

                if (data.success) {
                    token = data.token;
                    localStorage.setItem('adminToken', token);
                    showAdmin();
                    loadStats();
                    loadComments();
                } else {
                    // æ ¹æ®ä¸åŒçš„é”™è¯¯ç±»å‹æ˜¾ç¤ºä¸­æ–‡æç¤º
                    if (data.error === 'Invalid username or password') {
                        errorDiv.textContent = 'ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯';
                    } else if (data.error === 'Failed to login') {
                        errorDiv.textContent = 'ç™»å½•å¤±è´¥ï¼š' + (data.details || 'æœåŠ¡å™¨é”™è¯¯');
                    } else {
                        errorDiv.textContent = data.error || 'ç™»å½•å¤±è´¥';
                    }
                }
            } catch (e) {
                
                errorDiv.textContent = 'ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥è¿æ¥';
            }
        }

        // é€€å‡ºç™»å½•
        function doLogout() {
            if (confirm('ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ')) {
                localStorage.removeItem('adminToken');
                token = null;
                showLogin();
            }
        }

        // åŠ è½½ç»Ÿè®¡
        async function loadStats() {
            try {
                const [totalRes, pendingRes] = await Promise.all([
                    fetch(`${API}/comments`),
                    fetch(`${API}/comments?action=pending-count`)
                ]);
                const totalData = await totalRes.json();
                const pendingData = await pendingRes.json();

                const total = totalData.totalComments || 0;
                const pending = pendingData.count || 0;
                const approved = total - pending;

                document.getElementById('statTotal').textContent = total;
                document.getElementById('statPending').textContent = pending;
                document.getElementById('statApproved').textContent = approved;
            } catch (e) {
                
            }
        }

        // åŠ è½½ç•™è¨€
        async function loadComments() {
            const list = document.getElementById('commentsList');
            list.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';

            try {
                const res = await fetch(`${API}/comments?page=${currentPage}&limit=10&admin=true`);
                const data = await res.json();
                allComments = data.comments || [];
                totalPages = data.totalPages || 1;
                totalComments = data.totalComments || 0;

                renderComments();
                renderPagination();
            } catch (e) {

                list.innerHTML = '<div class="empty">åŠ è½½å¤±è´¥</div>';
            }
        }

        // æ¸²æŸ“ç•™è¨€
        function renderComments() {
            const list = document.getElementById('commentsList');
            let comments = allComments;

            if (currentTab === 'pending') {
                comments = comments.filter(c => !c.approved);
            } else if (currentTab === 'approved') {
                comments = comments.filter(c => c.approved);
            }

            if (comments.length === 0) {
                list.innerHTML = '<div class="empty">æš‚æ— ç•™è¨€</div>';
                const paginationContainer = document.getElementById('paginationContainer');
                if (paginationContainer) {
                    paginationContainer.innerHTML = '';
                }
                return;
            }

            list.innerHTML = comments.map(c => {
                const isApproved = c.approved === 1 || c.approved === true;
                return `
                <div class="comment-item">
                    <div class="comment-header">
                        <div class="comment-info">
                            <span class="comment-name">${escapeHtml(c.name)}</span>
                            <span class="comment-time">${formatDate(c.date)}</span>
                            ${c.ip ? `<span class="comment-ip">IP: ${c.ip}</span>` : ''}
                            ${c.location ? `<span class="comment-location">${escapeHtml(c.location)}</span>` : ''}
                        </div>
                        <span class="badge ${isApproved ? 'approved' : 'pending'}">${isApproved ? 'å·²å®¡æ ¸' : 'å¾…å®¡æ ¸'}</span>
                    </div>
                    <div class="comment-content">${escapeHtml(c.content)}</div>
                    ${c.reply ? `
                        <div class="comment-reply">
                            <strong>ç®¡ç†å‘˜å›å¤ï¼š</strong>${escapeHtml(c.reply)}
                            <div class="comment-reply-time">${formatDate(c.reply_date)}</div>
                        </div>
                    ` : ''}
                    <div class="comment-actions">
                        ${!isApproved ? `<button class="btn btn-success" data-id="${c.id}" data-action="approve">å®¡æ ¸é€šè¿‡</button>` : ''}
                        <button class="btn btn-primary" data-id="${c.id}" data-action="edit">ç¼–è¾‘</button>
                        <button class="btn btn-primary" data-id="${c.id}" data-action="reply">å›å¤</button>
                        <button class="btn btn-danger" data-id="${c.id}" data-action="delete">åˆ é™¤</button>
                    </div>
                </div>
            `;}).join('');

            // æ·»åŠ åˆ†é¡µ
            const paginationContainer = document.getElementById('paginationContainer');
            if (totalPages > 1 && paginationContainer) {
                paginationContainer.innerHTML = renderPaginationHTML();
            } else if (paginationContainer) {
                paginationContainer.innerHTML = '';
            }
        }

        // æ¸²æŸ“åˆ†é¡µHTML
        function renderPaginationHTML() {
            let html = '<div class="pagination">';
            html += `<span class="pagination-info">ç¬¬ ${currentPage} / ${totalPages} é¡µ</span>`;

            // ä¸Šä¸€é¡µ
            html += `<button ${currentPage === 1 ? 'disabled' : ''} onclick="goToPage(${currentPage - 1})">ä¸Šä¸€é¡µ</button>`;

            // é¡µç 
            for (let i = 1; i <= totalPages; i++) {
                if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
                    html += `<button class="${i === currentPage ? 'active' : ''}" onclick="goToPage(${i})">${i}</button>`;
                } else if (i === currentPage - 3 || i === currentPage + 3) {
                    html += '<span>...</span>';
                }
            }

            // ä¸‹ä¸€é¡µ
            html += `<button ${currentPage === totalPages ? 'disabled' : ''} onclick="goToPage(${currentPage + 1})">ä¸‹ä¸€é¡µ</button>`;
            html += '</div>';
            return html;
        }

        // è·³è½¬é¡µé¢
        function goToPage(page) {
            if (page < 1 || page > totalPages || page === currentPage) return;
            currentPage = page;
            loadComments();
        }

        // æ¸²æŸ“åˆ†é¡µ
        function renderPagination() {
            const paginationContainer = document.getElementById('paginationContainer');
            if (paginationContainer) {
                if (totalPages > 1) {
                    paginationContainer.innerHTML = renderPaginationHTML();
                } else {
                    paginationContainer.innerHTML = '';
                }
            }
        }

        // åˆ‡æ¢æ ‡ç­¾
        function switchTab(tab) {
            currentTab = tab;
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelector(`.tab[data-tab="${tab}"]`).classList.add('active');
            renderComments();
        }

        // å®¡æ ¸
        async function approve(id) {
            
            if (!confirm('ç¡®å®šå®¡æ ¸é€šè¿‡è¿™æ¡ç•™è¨€ï¼Ÿ')) return;

            try {
                const url = `${API}/comments/${id}/approve`;
                

                const res = await fetch(url, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                
                const data = await res.json();

                if (res.ok) {
                    loadComments();
                    loadStats();
                } else {
                    alert('æ“ä½œå¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (e) {
                
                alert('æ“ä½œå¤±è´¥: ' + e.message);
            }
        }

        // æ‰“å¼€ç¼–è¾‘
        function openEdit(id, content, approved) {
            const comment = allComments.find(c => String(c.id) === String(id));
            if (!comment) return;

            currentEditId = id;
            document.getElementById('editOriginal').textContent = comment.content;
            document.getElementById('editContent').value = comment.content;
            document.getElementById('editApproved').checked = comment.approved;
            document.getElementById('editModal').classList.add('show');
        }

        // æäº¤ç¼–è¾‘
        async function submitEdit() {
            const content = document.getElementById('editContent').value.trim();
            const approved = document.getElementById('editApproved').checked;

            if (!content) {
                alert('è¯·è¾“å…¥å†…å®¹');
                return;
            }

            try {
                const res = await fetch(`${API}/comments/${currentEditId}/edit`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ content, approved })
                });

                if (res.ok) {
                    closeModal('editModal');
                    loadComments();
                    loadStats();
                } else {
                    alert('æ“ä½œå¤±è´¥');
                }
            } catch (e) {
                
                alert('æ“ä½œå¤±è´¥');
            }
        }

        // æ‰“å¼€å›å¤
        function openReply(id) {
            
            const comment = allComments.find(c => String(c.id) === String(id));
            if (!comment) {
                
                return;
            }

            currentReplyId = id;
            document.getElementById('replyOriginal').textContent = comment.content;
            document.getElementById('replyContent').value = '';
            document.getElementById('replyModal').classList.add('show');
        }

        // æäº¤å›å¤
        async function submitReply() {
            const reply = document.getElementById('replyContent').value.trim();

            if (!reply) {
                alert('è¯·è¾“å…¥å›å¤å†…å®¹');
                return;
            }

            try {
                const url = `${API}/comments/${currentReplyId}/reply`;
                

                const res = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ reply })
                });

                const data = await res.json();

                if (res.ok) {
                    closeModal('replyModal');
                    loadComments();
                    loadStats();
                } else {
                    alert('æ“ä½œå¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (e) {
                
                alert('æ“ä½œå¤±è´¥: ' + e.message);
            }
        }

        // åˆ é™¤
        async function delComment(id) {
            if (!confirm('ç¡®å®šåˆ é™¤è¿™æ¡ç•™è¨€ï¼Ÿ')) return;

            try {
                const res = await fetch(`${API}/comments/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (res.ok) {
                    loadComments();
                    loadStats();
                } else {
                    alert('æ“ä½œå¤±è´¥');
                }
            } catch (e) {
                
                alert('æ“ä½œå¤±è´¥');
            }
        }

        // å…³é—­æ¨¡æ€æ¡†
        function closeModal(id) {
            document.getElementById(id).classList.remove('show');
        }

        // æ ¼å¼åŒ–æ—¥æœŸ
        function formatDate(date) {
            if (!date) return '';
            return new Date(date).toLocaleString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // HTML è½¬ä¹‰
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // JavaScript å­—ç¬¦ä¸²è½¬ä¹‰
        function escapeJs(text) {
            if (!text) return '';
            return text.replace(/\\/g, '\\\\').replace(/'/g, "\\'").replace(/"/g, '\\"').replace(/\n/g, '\\n').replace(/\r/g, '\\r');
        }

        // ç‚¹å‡»é®ç½©å…³é—­
        document.querySelectorAll('.modal-overlay').forEach(modal => {
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.classList.remove('show');
                }
            });
        });

        // å¤‡ä»½ç•™è¨€
        async function backupComments() {
            if (!confirm('ç¡®å®šè¦å¤‡ä»½æ‰€æœ‰ç•™è¨€å—ï¼Ÿ')) return;

            try {
                const res = await fetch(`${API}/admin/backup`, {
                    method: 'GET',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (res.ok) {
                    const blob = await res.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `comments_backup_${new Date().toISOString().split('T')[0]}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                    alert('å¤‡ä»½æˆåŠŸ');
                } else {
                    alert('å¤‡ä»½å¤±è´¥');
                }
            } catch (e) {
                
                alert('å¤‡ä»½å¤±è´¥: ' + e.message);
            }
        }

        // è¿˜åŸç•™è¨€
        async function restoreComments(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (!confirm('è¿˜åŸå°†æ¸…ç©ºç°æœ‰æ‰€æœ‰æ•°æ®ï¼Œç¡®å®šè¦ç»§ç»­å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) return;

            try {
                const text = await file.text();
                const data = JSON.parse(text);

                if (!data.comments || !Array.isArray(data.comments)) {
                    alert('å¤‡ä»½æ–‡ä»¶æ ¼å¼é”™è¯¯');
                    return;
                }

                if (!confirm(`ç¡®å®šè¦è¿˜åŸ ${data.comments.length} æ¡ç•™è¨€å—ï¼Ÿ`)) return;

                const res = await fetch(`${API}/admin/restore`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ comments: data.comments })
                });

                if (res.ok) {
                    const result = await res.json();
                    alert(result.message || 'è¿˜åŸæˆåŠŸ');
                    loadComments();
                    loadStats();
                } else {
                    const error = await res.json();
                    alert('è¿˜åŸå¤±è´¥: ' + (error.error || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (e) {
                
                alert('è¿˜åŸå¤±è´¥: ' + e.message);
            }

            // æ¸…ç©ºæ–‡ä»¶è¾“å…¥
            event.target.value = '';
        }

        // å›è½¦ç™»å½•
        document.getElementById('loginPassword').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') doLogin();
        });

        // äº‹ä»¶å§”æ‰˜å¤„ç†æŒ‰é’®ç‚¹å‡»
        document.getElementById('commentsList').addEventListener('click', (e) => {
            const button = e.target.closest('button[data-action]');
            if (!button) return;

            const id = button.getAttribute('data-id');
            const action = button.getAttribute('data-action');

            

            if (action === 'approve') {
                approve(id);
            } else if (action === 'edit') {
                const comment = allComments.find(c => String(c.id) === String(id));
                if (comment) {
                    openEdit(id, comment.content, comment.approved);
                }
            } else if (action === 'reply') {
                openReply(id);
            } else if (action === 'delete') {
                delComment(id);
            }
        });

        // å¯åŠ¨
        init();
    </script>
</body>
</html>
